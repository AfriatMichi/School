<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×˜×¢×™× ×ª ×ª×œ××™×“×™× ×œ××¢×¨×›×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Rubik', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-12">
                <div class="mx-auto mb-4 h-16 w-16 text-blue-600">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">×˜×¢×™× ×ª ×ª×œ××™×“×™×</h1>
                <p class="text-xl text-gray-600">×”×•×¡×£ ×¨×©×™××ª ×ª×œ××™×“×™× ×œ×›×™×ª×”</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-8">
                <!-- ×‘×—×™×¨×ª ×©×›×‘×” ×•××§×‘×™×œ×” -->
                <div class="mb-8">
                    <label class="block text-gray-700 text-lg font-bold mb-4">×‘×—×¨ ×©×›×‘×” ×•××§×‘×™×œ×”:</label>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-600 text-sm font-medium mb-2">×©×›×‘×”:</label>
                            <select id="gradeSelector" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">×‘×—×¨ ×©×›×‘×”</option>
                                <option value="×–">×–</option>
                                <option value="×—">×—</option>
                                <option value="×˜">×˜</option>
                                <option value="×™">×™</option>
                                <option value="×™×">×™×</option>
                                <option value="×™×‘">×™×‘</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-600 text-sm font-medium mb-2">××§×‘×™×œ×”:</label>
                            <input 
                                type="number" 
                                id="parallelInput" 
                                min="1" 
                                max="10"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="××¡×¤×¨ ××§×‘×™×œ×”"
                            >
                        </div>
                    </div>
                    <div id="classDisplay" class="hidden">
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <p class="text-blue-800 font-medium">×›×™×ª×” × ×‘×—×¨×ª: <span id="selectedClassName" class="font-bold"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ×”×¢×œ××ª ×§×•×‘×¥ ××§×¡×œ -->
                <div class="mb-8">
                    <label class="block text-gray-700 text-lg font-bold mb-4">×”×¢×œ××ª ×§×•×‘×¥ ××§×¡×œ:</label>
                    <div 
                        id="fileDropZone"
                        class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-colors hover:border-blue-400"
                        ondrop="handleFileDrop(event)"
                        ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)"
                    >
                        <div class="mx-auto mb-4 h-12 w-12 text-gray-400">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <p class="text-gray-600 mb-2">×’×¨×•×¨ ×§×•×‘×¥ ××§×¡×œ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                        <p class="text-sm text-gray-500 mb-4">×¤×•×¨××˜ × ×“×¨×©: ××¡', ×©× ×”×ª×œ××™×“, ××™×Ÿ, ×©×›×‘×”, ××§×‘×™×œ×”</p>
                        <input 
                            type="file" 
                            id="excelFileInput" 
                            accept=".xlsx,.xls,.csv"
                            class="hidden"
                        >
                        <button 
                            onclick="document.getElementById('excelFileInput').click()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                            ×‘×—×¨ ×§×•×‘×¥
                        </button>
                    </div>
                </div>

                <!-- ×ª×™×‘×ª ×˜×§×¡×˜ ×œ×¨×©×™××ª ×ª×œ××™×“×™× (×œ×’×™×‘×•×™) -->
                <div class="mb-8">
                    <label class="block text-gray-700 text-lg font-bold mb-4">×¨×©×™××ª ×ª×œ××™×“×™× (×œ×’×™×‘×•×™):</label>
                    <textarea 
                        id="studentsList" 
                        class="w-full h-32 p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                        placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×¨×©×™××ª ×”×ª×œ××™×“×™× ×›×’×™×‘×•×™.&#10;×›×œ ×ª×œ××™×“ ×‘×©×•×¨×” ×—×“×©×”."
                    ></textarea>
                </div>

                <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
                <div class="flex justify-between items-center">
                    <button 
                        onclick="window.location.href='index.html'" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                    >
                        ×—×–×•×¨ ×œ××¡×š ×”×¨××©×™
                    </button>
                    <div class="flex gap-3">
                        <button 
                            onclick="testDatabaseConnection()"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-3 rounded-lg font-medium transition-colors"
                        >
                            ğŸ”Œ ×‘×“×•×§ ×—×™×‘×•×¨
                        </button>
                        <button 
                            onclick="deleteAllStudents()"
                            id="deleteButton"
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                            disabled
                        >
                            ××—×§ ××ª ×›×œ ×”×ª×œ××™×“×™×
                        </button>
                        <button 
                            onclick="loadStudents()" 
                            id="loadButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
                            disabled
                        >
                            ×˜×¢×Ÿ ×ª×œ××™×“×™×
                        </button>
                    </div>
                </div>
            </div>

            <!-- ×”×•×“×¢×•×ª ××¢×¨×›×ª -->
            <div id="messages" class="mt-6"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- SheetJS for Excel file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Application Scripts -->
    <script src="services/DatabaseService.js"></script>
    <script src="services/DataService.js"></script>

    <script>
        let selectedClass = null;
        const loadButton = document.getElementById('loadButton');
        const deleteButton = document.getElementById('deleteButton');
        const messagesDiv = document.getElementById('messages');
        const studentsList = document.getElementById('studentsList');
        const gradeSelector = document.getElementById('gradeSelector');
        const parallelInput = document.getElementById('parallelInput');
        const excelFileInput = document.getElementById('excelFileInput');
        const classDisplay = document.getElementById('classDisplay');
        const selectedClassName = document.getElementById('selectedClassName');

        // ××ª×—×•×œ
        document.addEventListener('DOMContentLoaded', function() {
            // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×©×™× ×•×™×™×
            gradeSelector.addEventListener('change', updateClassDisplay);
            parallelInput.addEventListener('input', updateClassDisplay);
            
            // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×§×•×‘×¥ ××§×¡×œ
            excelFileInput.addEventListener('change', handleExcelFile);
        });

        // ×¤×•× ×§×¦×™×•×ª ×œ×˜×™×¤×•×œ ×‘×’×¨×™×¨×ª ×§×‘×¦×™×
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.includes('excel') || file.type.includes('spreadsheet') || file.name.endsWith('.csv')) {
                    excelFileInput.files = files;
                    handleExcelFile({ target: { files: files } });
                } else {
                    showMessage('× × ×œ×”×¢×œ×•×ª ×§×•×‘×¥ ××§×¡×œ ××• CSV ×‘×œ×‘×“', 'error');
                }
            }
        }

        // ×¢×“×›×•×Ÿ ×”×¦×’×ª ×”×›×™×ª×” ×”× ×‘×—×¨×ª
        function updateClassDisplay() {
            const grade = gradeSelector.value;
            const parallel = parallelInput.value;
            
            if (grade && parallel) {
                selectedClass = `${grade}${parallel}`;
                selectedClassName.textContent = selectedClass;
                classDisplay.classList.remove('hidden');
                
                // ×”×¤×¢×œ×ª ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×”
                loadButton.disabled = false;
                deleteButton.disabled = false;
            } else {
                selectedClass = null;
                classDisplay.classList.add('hidden');
                loadButton.disabled = true;
                deleteButton.disabled = true;
            }
        }

        // ×˜×™×¤×•×œ ×‘×§×•×‘×¥ ××§×¡×œ
        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showMessage('××¢×‘×“ ×§×•×‘×¥ ××§×¡×œ...', 'info');
                
                // ×§×¨×™××ª ×”×§×•×‘×¥
                const data = await readExcelFile(file);
                
                // ×¢×™×‘×•×“ ×”× ×ª×•× ×™×
                const students = processExcelData(data);
                
                if (students.length === 0) {
                    showMessage('×œ× × ××¦××• ×ª×œ××™×“×™× ×‘×§×•×‘×¥', 'error');
                    return;
                }

                // ×”×¦×’×ª ×”× ×ª×•× ×™× ×‘×ª×™×‘×ª ×”×˜×§×¡×˜
                studentsList.value = students.map(s => `${s.id}\t${s.name}\t${s.gender}\t${s.grade}\t${s.parallel}`).join('\n');
                
                showMessage(`âœ… ${students.length} ×ª×œ××™×“×™× × ×˜×¢× ×• ××”×§×•×‘×¥`, 'success');
                
                // ×¢×“×›×•×Ÿ ×”×××©×§
                if (students.length > 0) {
                    // × ×™×¡×™×•×Ÿ ×œ×–×”×•×ª ×©×›×‘×” ×•××§×‘×™×œ×” ××”× ×ª×•× ×™×
                    const firstStudent = students[0];
                    if (firstStudent.grade && firstStudent.parallel) {
                        gradeSelector.value = firstStudent.grade;
                        parallelInput.value = firstStudent.parallel;
                        updateClassDisplay();
                    }
                }
                
            } catch (error) {
                console.error('×©×’×™××” ×‘×¢×™×‘×•×“ ×§×•×‘×¥ ××§×¡×œ:', error);
                showMessage('âŒ ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥', 'error');
            }
        }

        // ×§×¨×™××ª ×§×•×‘×¥ ××§×¡×œ
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsBinaryString(file);
            });
        }

        // ×¢×™×‘×•×“ × ×ª×•× ×™ ×”××§×¡×œ
        function processExcelData(data) {
            if (!data || data.length < 2) return [];
            
            const students = [];
            const headers = data[0];
            
            // ×—×™×¤×•×© ××™× ×“×§×¡×™ ×”×¢××•×“×•×ª
            const idIndex = headers.findIndex(h => h === '××¡\'');
            const nameIndex = headers.findIndex(h => h === '×©× ×”×ª×œ××™×“');
            const genderIndex = headers.findIndex(h => h === '××™×Ÿ');
            const gradeIndex = headers.findIndex(h => h === '×©×›×‘×”');
            const parallelIndex = headers.findIndex(h => h === '××§×‘×™×œ×”');
            
            if (idIndex === -1 || nameIndex === -1) {
                throw new Error('×¤×•×¨××˜ ×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ - ×—×¡×¨×•×ª ×¢××•×“×•×ª × ×“×¨×©×•×ª');
            }
            
            // ×¢×™×‘×•×“ ×”×©×•×¨×•×ª
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length < 2) continue;
                
                const student = {
                    id: row[idIndex] || Date.now() + i,
                    name: row[nameIndex] || '',
                    gender: genderIndex !== -1 ? row[genderIndex] : '',
                    grade: gradeIndex !== -1 ? row[gradeIndex] : '',
                    parallel: parallelIndex !== -1 ? row[parallelIndex] : ''
                };
                
                if (student.name.trim()) {
                    students.push(student);
                }
            }
            
            return students;
        }

        // ×˜×¢×™× ×ª ×ª×œ××™×“×™×
        async function loadStudents() {
            if (!selectedClass || !studentsList.value.trim()) {
                showMessage('× × ×œ×‘×—×•×¨ ×›×™×ª×” ×•×œ×”×–×™×Ÿ ×¨×©×™××ª ×ª×œ××™×“×™×', 'error');
                return;
            }

            try {
                // ×¢×™×‘×•×“ ×¨×©×™××ª ×”×ª×œ××™×“×™×
                const students = studentsList.value
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line)
                    .map((line, index) => {
                        const parts = line.split('\t');
                        if (parts.length >= 2) {
                            return {
                                id: parts[0] || Date.now() + index,
                                name: parts[1] || '',
                                gender: parts[2] || '',
                                grade: parts[3] || '',
                                parallel: parts[4] || '',
                                status: 0,
                                lastAttendance: null,
                                timestamp: null
                            };
                        } else {
                            // fallback ×œ×¤×•×¨××˜ ×”×™×©×Ÿ
                            return {
                                name: line,
                                id: Date.now() + index,
                                status: 0,
                                lastAttendance: null,
                                timestamp: null
                            };
                        }
                    });

                if (students.length === 0) {
                    showMessage('×œ× × ××¦××• ×ª×œ××™×“×™× ×‘×¨×©×™××”', 'error');
                    return;
                }

                // ×—×™×œ×•×¥ ×©×›×‘×” ×•××§×‘×™×œ×” ××©× ×”×›×™×ª×”
                const grade = selectedClass.replace(/\d+/g, '');
                const parallel = selectedClass.replace(/\D/g, '');

                // ×©××™×¨×” ×‘-Firebase ×¢× ×”××‘× ×” ×”×—×“×©
                await window.databaseService.saveClassDataWithGradeAndParallel(selectedClass, {
                    students,
                    lastUpdated: new Date().toISOString()
                }, grade, parallel);

                showMessage(`âœ… ${students.length} ×ª×œ××™×“×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ×œ×›×™×ª×” ${selectedClass}`, 'success');
                studentsList.value = ''; // × ×™×§×•×™ ×”×ª×™×‘×”
                
                // ×¢×“×›×•×Ÿ ×”×××©×§
                setTimeout(() => {
                    if (confirm('×”×× ×‘×¨×¦×•× ×š ×œ×˜×¢×•×Ÿ ×ª×œ××™×“×™× ×œ×›×™×ª×” × ×•×¡×¤×ª?')) {
                        // ××™×¤×•×¡ ×”×‘×—×™×¨×”
                        gradeSelector.value = '';
                        parallelInput.value = '';
                        updateClassDisplay();
                    } else {
                        // ××¢×‘×¨ ×œ××¡×š ×”×¨××©×™
                        window.location.href = 'index.html';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×œ××™×“×™×:', error);
                showMessage('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª×œ××™×“×™×', 'error');
            }
        }

        // ××—×™×§×ª ×›×œ ×”×ª×œ××™×“×™×
        async function deleteAllStudents() {
            if (!selectedClass) {
                showMessage('× × ×œ×‘×—×•×¨ ×›×™×ª×” ×ª×—×™×œ×”', 'error');
                return;
            }

            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×ª×œ××™×“×™× ××›×™×ª×” ${selectedClass}?`)) {
                return;
            }

            try {
                await window.databaseService.deleteAllStudentsFromClass(selectedClass);
                showMessage(`âœ… ×›×œ ×”×ª×œ××™×“×™× × ××—×§×• ×‘×”×¦×œ×—×” ××›×™×ª×” ${selectedClass}`, 'success');
                
                // × ×™×§×•×™ ×”×××©×§
                studentsList.value = '';
                selectedClass = null;
                classDisplay.classList.add('hidden');
                loadButton.disabled = true;
                deleteButton.disabled = true;
                
                // ×¢×“×›×•×Ÿ ×”×××©×§
                setTimeout(() => {
                    if (confirm('×”×× ×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×œ××™×“×™× ××›×™×ª×” × ×•×¡×¤×ª?')) {
                        // ××™×¤×•×¡ ×”×‘×—×™×¨×”
                        gradeSelector.value = '';
                        parallelInput.value = '';
                        updateClassDisplay();
                    } else {
                        // ××¢×‘×¨ ×œ××¡×š ×”×¨××©×™
                        window.location.href = 'index.html';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('×©×’×™××” ×‘××—×™×§×ª ×ª×œ××™×“×™×:', error);
                showMessage('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×ª×œ××™×“×™×', 'error');
            }
        }

        // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×
        async function testDatabaseConnection() {
            try {
                showMessage('×‘×•×“×§ ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×...', 'info');
                const status = await window.databaseService.testConnection();
                if (status) {
                    showMessage('âœ… ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™× ×ª×§×™×Ÿ', 'success');
                } else {
                    showMessage('âŒ ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×', 'error');
                }
            } catch (error) {
                showMessage('âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×”×—×™×‘×•×¨: ' + error.message, 'error');
            }
        }

        // ×”×¦×’×ª ×”×•×“×¢×•×ª
        function showMessage(text, type = 'info') {
            const colors = {
                success: 'bg-green-100 border-green-500 text-green-700',
                error: 'bg-red-100 border-red-500 text-red-700',
                info: 'bg-blue-100 border-blue-500 text-blue-700'
            };

            messagesDiv.innerHTML = `
                <div class="p-4 rounded-lg border ${colors[type]} text-center">
                    ${text}
                </div>
            `;

            // ×”×¡×ª×¨×ª ×”×”×•×“×¢×” ××—×¨×™ 5 ×©× ×™×•×ª
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // ××ª×—×•×œ ×”×“×£
        window.onload = async function() {
            try {
                // ×”××ª× ×” ×œ×˜×¢×™× ×ª Firebase
                await new Promise((resolve, reject) => {
                    const checkFirebase = () => {
                        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });

                // displayClasses(); // This function is no longer needed as updateClassDisplay handles class selection
            } catch (error) {
                console.error('×©×’×™××” ×‘××ª×—×•×œ:', error);
                showMessage('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª', 'error');
            }
        };
    </script>
</body>
</html>